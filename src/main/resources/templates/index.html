<!doctype html>

<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
	class="no-js" lang="">
<head>
<th:block th:include="head::head_link"></th:block>
<meta charset="utf8">
<link rel="stylesheet" th:href="@{/css/index.css}">
<link rel="stylesheet" th:href="@{/css/newProductCard.css}">

<link rel="stylesheet" th:href="@{/css/animate.css}">

<link rel="stylesheet" th:href="@{/css/button.css}">
<link th:replace="commonjs::js"></link>
<title>TT_Mart</title>
</head>

<body class="bg-light">
	<!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
	<div class="container-fluid" ng-app="products" 
		ng-controller="myControl">

		<!-- nav -->

		<div th:replace="head::nav"></div>

		<!-- nav end -->

		<!-- carousel  -->

		<div class="row my-2  " style="margin-bottom: 20px;">
			<div id="carouselExampleIndicators"
				class="carousel slide col-md-12 justify-content-center"
				data-ride="carousel">
				<ol class="carousel-indicators">
					<li th:each="car,stat:${carousels}"
						data-target="#carouselExampleIndicators"
						th:data-slide-to="${stat.index}"
						th:class="${stat.index}==0?active:''"></li>
				</ol>
				<div class="carousel-inner">

					<div th:each="car,stat:${carousels}"
						th:class="${stat.index}==0?'carousel-item active':'carousel-item'">
						<a th:href="${car.redirect_url}"> <img class="d-block w-100"
							th:src="${car.pic_url}" alt="First slide">
						</a>
						<div class="carousel-caption d-none d-md-block">
							<h5 th:text="${car.title}"></h5>
						</div>
					</div>


				</div>
				<a class="carousel-control-prev" href="#carouselExampleIndicators"
					role="button" data-slide="prev"> <span
					class="carousel-control-prev-icon" aria-hidden="true"></span> <span
					class="sr-only">Previous</span>
				</a> <a class="carousel-control-next" href="#carouselExampleIndicators"
					role="button" data-slide="next"> <span
					class="carousel-control-next-icon" aria-hidden="true"></span> <span
					class="sr-only">Next</span>
				</a>
			</div>
		</div>
		<!-- carousel end  -->
		<!-- search  -->
		<div class="row">




			<div class="input-group  col-md-8 mt-4 offset-md-2">
				<input ng-keypress="$event.keyCode==13&&search()"
					ng-model="search_value" id="input_search" type="text"
					class="form-control typeahead"
					th:placeholder="#{index.search.name}" autocomplete="off"
					aria-label="Recipient's username" aria-describedby="basic-addon2">
				<div class="input-group-append">
					<button ng-click="search()" class="btn btn-outline-secondary"
						type="button">搜索</button>
				</div>
			</div>



		</div>
		<!-- search end -->
		<!-- product display -->
		<div class="row" id="products">
			<div ng-show="products==null"
				class="col-md-12 justify-content-center p-3" align="center">
				<div class="loader"></div>
			</div>
		</div>
		<div class="container-fluid pt-1">
			
		
			<div class="row" ng-show="products!=null">

				<div class="col-lg-2 col-xl-2 col-md-2  col-sm-12 col-xs-12"
					id="sidebar">

					<div class="row">
						<div class="col-12">
						<div style=" border: 1px solid #ddd; ">
						<div style="border-bottom: 1px solid #c7d2d4; font-weight: bold; background-color: #efefef;
						 width: 100%;  min-height: 40px;
						    padding: 10px;
						    border-radius: 0;
						    position: relative;">Filter by</div>  
							<div data-title="category" style="width: 100%">

									
						
									<ul style="list-style-type: none;margin: 0;padding: 0;">
										<li>
											<a href=""   class=" tree-toggler" style="text-decoration: none; margin-left: 5px;"  	th:text="#{product.category.name}">商品种类</a>
										<ul class="category-list-group tree" ng-cloak>																
											<li class="category-list" data-ng-repeat="cate in tree">
												
												<a ng-click="selectCate($event,cate.id)" href=""  ng-bind="cate.text" >Link</a>
												<ul ng-if="cate.nodes.length>0" class="category-list-group  tree">
													<li class="category-list" data-ng-repeat="cate2 in cate.nodes">
														<a ng-click="selectCate($event,cate2.id)"  href=""  ng-bind="cate2.text" >Link</a>
														<ul ng-if="cate.nodes.length>0" class=" category-list-group tree">
														<li class="category-list" data-ng-repeat="cate3 in cate2.nodes">
															<a ng-click="selectCate($event,cate3.id)"  href="" ng-bind="cate3.text">Link</a>
																<ul ng-if="cate3.nodes.length>0" class=" category-list-group tree">
																	<li class="category-list" data-ng-repeat="cate4 in cate3.nodes">
																		<a ng-click="selectCate($event,cate4.id)"   href="" ng-bind="cate4.text"></a>
																
																			<ul ng-if="cate4.nodes.length>0" class=" category-list-group tree">
																					<li class="category-list" data-ng-repeat="cate5 in cate4.nodes">
																						<a ng-click="selectCate($event,cate5.id)"   href="" ng-bind="cate5.text">Link</a>
																						
																			
																			
																					</li>
																		
																				</ul>
															
																	</li>
														
																</ul>
														
														
														</li>
													
													</ul>
													
													</li>
												
												</ul>
											</li>
									
										</ul>
 									</li>
									</ul>
							
							</div>
							<div class="dropdown-divider"></div>
							
							<div>
								<span  style="text-decoration: none; margin-left: 5px; margin-bottom: 10px;"  >选项</span>
							</div>
							<div style="margin-left: 15px;" class="custom-control custom-checkbox">
							  <input type="checkbox" class="custom-control-input" ng-model="offerConfirmed" ng-bind="offerConfirmed" id="input_offer" ng-change="offer()" >
							  <label class="custom-control-label" for="input_offer" th:text="#{index.left.offer}">促销</label>
							</div>
						</div>
						</div>
					</div>
						
						
				</div>
				<div class="col-lg-10 col-xs-12 col-sm-12">
					<div class="row">
						<div class="col-lg-12" >
							<small>showing <strong ng-bind="products.length">12</strong>
								products
							</small>
							<div class="pull-right">
							<!-- 	<a class="btn btn-light" href="#"><i class="fa fa-th-large"></i></a>
								<a class="btn btn-light" href="#"><i class="fa fa-list"></i></a> -->
								
								<a class="btn btn-light btn-sm text-muted dropdown-toggle"
									href="#" data-toggle="dropdown" aria-haspopup="true"
									aria-expanded="false">默认排序</a>
								<div class="dropdown-menu">
									<a class="dropdown-item active" href="#lower-price"   ng-click="sort('lower-price')"  th:text="#{index.sort.priceFromLow}">Popularity</a> 
									<a class="dropdown-item" href="#lower-price"  ng-click="sort('high-price')"  th:text="#{index.sort.priceFromLow}">Popularity</a> 
									<a class="dropdown-item" href="#lower-price"  ng-click="sort('latest')"  th:text="#{index.sort.priceFromLow}">Popularity</a> 
									<a class="dropdown-item" href="#lower-price"  ng-click="sort('oldest')"  th:text="#{index.sort.priceFromLow}">Popularity</a> 
									<a class="dropdown-item" href="#lower-price"  ng-click="sort('reset')"  >重置</a> 

								</div>
							</div>
						</div>
					</div>
					<hr>
					<div class='row no-gutters' >
					
						<div class="col-xl-2 col-lg-2 col-md-4 col-sm-6 col-6 mb-1"
							ng-repeat="product in products" style="padding-left: 5px; padding-right: 5px;" ng-cloak>
							<div class="product-frame">
								<span class="product-card-cart" style="margin-left: 1px;" ng-bind="product.offer">热销</span>
							<a href="" ng-click="productDetail(product.id)">
							<img  ng-src="{{product.imgUrl}}" ng-attr-data-id="{{product.id}}"
										class="product-img-wrap">
										</a>
								<hr style="margin: 0px; padding: 0px;">							
								<div >
								<a href="" ng-click="productDetail(product.id)" ><span class='line-clamp'   ng-bind="product.name">油麦菜</span></a>			
								<span  class='line-clamp-info'  ng-bind="(product.quantityDesc==null||product.quantityDesc=='')?'&nbsp;':product.quantityDesc">每公斤</span>
											
								<a href="" ng-click="productDetail(product.id)"><span class='offer-info' ng-bind="(product.promotionTitle==null||product.promotionTitle=='')?'&nbsp;':product.promotionTitle">买二增一</span></a>
											
								<div class='price-frame'>
								<span ng-bind="product.moneyDisplayed" class="price-offer price">5.55$</span> 
    							<span class="old-price" ng-bind="product.oldMoneyDisplayed">6.88$</span>
								<span style="color: red; font-size: small; "  ng-show="product.quantity==0"  th:text="#{index.outofstock}"> </span>
								
								</div>			
			
							</div>
						
									<div align="center">
									<button ng-click="addCart($index,product.id)" 
									 class="button button-small  button-primary trollery-button" >添加到购物车<i style="font-size: 16px;" class="fa fa-cart-plus"></i></button>
									</div>
								
								
							</div>
						</div>
					
					</div>
					
				



					<hr>
					<div class="row my-5" >

						<!--Pagination -->
						<ul class=" ml-auto mr-auto pagination justify-content-center" ng-cloak>

							<!--First-->
							<li
								ng-class="pages.currentPage==0?'page-item disabled':'page-item'"><a
								ng-click="getContent(0)" class="page-link">First</a></li>

							<!--Arrow left-->
							<li
								ng-class="pages.currentPage==0?'page-item disabled':'page-item'">
								<a class="page-link" aria-label="Previous"
								ng-click="getContent(pages.currentPage-1)"> <span
									aria-hidden="true">&laquo;</span> <span class="sr-only">Previous</span>
							</a>
							</li>



							<li ng-repeat="ps in pageArray" 
								ng-class="ps==(pages.currentPage+1)?'page-item active':'page-item'"><a
								class="page-link" href="#"
								ng-click="ps==(pages.currentPage+1)?'':getContent(ps-1)">{{ps}}</a></li>

							<!--Arrow right-->
							<li
								ng-class="pages.currentPage==(pages.totalPage-1)?'page-item disabled':'page-item'">
								<a ng-click="getContent(pages.currentPage+1)" class="page-link"
								aria-label="Next"> <span aria-hidden="true">&raquo;</span> <span
									class="sr-only">Next</span>
							</a>
							</li>

							<!--Last-->
							<li
								ng-class="pages.currentPage==(pages.totalPage-1)?'page-item disabled':'page-item'">
								<a ng-click="getContent(pages.totalPage-1)" class="page-link">Last</a>
							</li>

						</ul>
						

					</div>
					<div class='row'>
					<small class="ml-auto"
							ng-bind="'showing '+pages.currentPage*pages.pageSize+'-'+(pages.currentPage*pages.pageSize+24)+' of  '+pages.totalCount+' results'"></small>
					
					</div>
					<!-- pagination end -->

				</div>
			</div>
		</div>
	<script type="text/javascript" th:src="@{/js/angular-route.min.js}"></script>
		<!-- Footer -->
		<div th:replace="footer::footer"></div>
		<!-- Footer -->
	</div>






	<script type="text/javascript" th:src="@{/js/popper.min.js}"></script>
		<script type="text/javascript" th:src="@{/js/vendor/jquery-3.3.1.min.js}"></script>
	
	<script type="text/javascript"
		th:src="@{/js/bootstrap3-typeahead.min.js}"></script>
	<script type="text/javascript" th:src="@{/js/bloodhound.min.js}"></script>
	<script type="text/javascript" th:src="@{/js/bootstrap-notify.min.js}"></script>
	

	<script type="text/javascript" th:src="@{/js/MyNotify.js}"></script>
	

	<script type="text/javascript" th:src="@{/js/jsLocationUtil.js}"></script>
	
	<script th:inline="javascript">
		
	
	var u=[[@{/}]].replace("\\","");
	var csrfName= [[${_csrf.headerName}]];
    var  token= [[${_csrf.token}]];
	var url=u+"product/getProducts".replace("\\","");
	var app = angular.module('products',['ngRoute']).config(['$locationProvider', function($locationProvider) {
		  $locationProvider.html5Mode({enabled:true,requireBase: false});
	}]).controller('myControl', function($scope,$http,$location) {
		if($location.search()["offerConfirmed"]){
			$scope.offerConfirmed=$location.search()["offerConfirmed"]==1?true:false;
		}
		
		var categories=[[${categories}]]
		var tree=[];
		generateTree(tree,categories);
	 	$scope.tree=tree;
	 	
		$scope.selectCate=function ($event,id){
			$event.preventDefault();		
			goToDesiredUrl("categoryId",id);
		
		}
		$scope.sort=function(type){

			goToDesiredUrl("sort",type);
		}
		$scope.offer=function (){
			
			goToDesiredUrl("offerConfirmed",$scope.offerConfirmed?1:0);
		}
	    $scope.productDetail=function (id){			
	    						window.location.href=(u+"productdetail/"+id);
	    					}
	    $scope.addCart=function($index, id){
	    	if($scope.products[$index].quantity==0)
	    		{
	    		showNotifactionInCenter($scope.products[$index].name+"没有库存了",true,"warning");	    	
	    		return ;
	    		}
	    	 var context = [[@{/}]]+"cart/add";
		        	context=context.replace("\\","");
	    	 $http.defaults.headers.common[csrfName] = token;
	    	 $http({  
				    method:'post',  
				    url:context,  				    
				    data:[{productid:id,quantity:1}] 					
				}).then(function successCallback(req){  			
					if(req["data"]["code"]==200){
						showNotifaction([[#{index.shopping.cart.success}]])
					}	
					
				})  
			
		        	
	    }
	    $scope.search=function (){
	    	var inputValue=$scope.search_value;
	    	load($scope,$http,0,{name:inputValue}); 	
	    }
		load($scope,$http,0,{});
	    $scope.getContent=function(requestPage){	    	
	    	load($scope,$http,requestPage,{});
	    }
	});
	
	function processUrl(){
		
	}
	function load($scope,$http,currentPage,dataValue){
		 $http.defaults.headers.common[csrfName] = token;
			$http({  

			    method:'post',  

			    url:url+"?currentPage="+currentPage+"&pageSize=24",  

			    data:dataValue 
				

			}).then(function successCallback(req){  			
				$scope.products=req["data"]["result"]["beans"];
				$scope.pages=req["data"]["result"];
			
				var start=$scope.pages["beginNumber"]+1;
				var end=$scope.pages["endNumber"]+1;
			
				var input=[];
				for(var i=start;i<end;i++){
		    		input.push(i);
		    	}
				$scope.pageArray=input;			
			})  
		
	}
	
	$().ready(function (){

		   var context = [[@{/}]]+"product/getName/";
	        	context=context.replace("\\","");
	   
		   var engine = new Bloodhound({
			   datumTokenizer: Bloodhound.tokenizers.whitespace,
			   queryTokenizer: Bloodhound.tokenizers.whitespace,
			   identify: function(obj) { return obj.id; },
			   prefetch: context+"1.json",
			   
			   remote: {
				    url: context+"-1.json",				   
				  }
			 });
		   engine.initialize();
		  

		   $('#input_search').typeahead({
		     fitToElement: true,
		   	 items:8,
		   	 minLength:1,
		   	 delay:500,	
		     name: 'all-category',
		     display: 'name',
		     source: engine.ttAdapter()
		   });
		   
		   
		
		
	})
	
	$().ready(function (){
		
		
		  $('a.tree-toggler').click(function () {
		        $(this).parent().children('ul.tree').toggle(300);
		    });
		
	})
	function generateTree(parent,categories){
		//adding parents
		if(parent.length==0){
			for(var i=0;i<categories.length;i++){
				var category=categories[i];
				if(category.parent==null){
					
					var node={text:category.text,id:category.id,href:"#"+category.text,nodes:[]
					
	
					  };					
					parent.push(node);
				}
			}
			 for (var i=0; i<parent.length; i++) {
					generateTree(parent[i],categories);	
			}
		
		}else{					
		for(var i=0;i<categories.length;i++){
				var category=categories[i];
			if(parent.id==category.parent){
				var node={text:category.text,id:category.id,href:"#"+category.text,nodes:[]
						
		
				};
				parent.nodes.push(node);
				generateTree(node,categories);
			}
		}	
		}
	}
	
	
	</script>
</body>

</html>
